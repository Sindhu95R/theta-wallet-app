<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.6.1/dist/web3.min.js"></script>
</head>
<body>
    <h1>Batch Payment</h1>
    <form id="batchPaymentForm">
        <div id="recipients">
            <div class="recipient">
                <label>Recipient Address:</label>
                <input type="text" name="recipient" required>
                <label>Amount (in ETH):</label>
                <input type="number" step="0.01" name="amount" required>
            </div>
        </div>
        <button type="button" onclick="addRecipient()">Add Another Recipient</button>
        <br><br>
        <button type="submit">Submit</button>
    </form>
    <p id="status"></p>

    <script>
        let web3;
        let contract;
        const contractAddress = "0x3509A858c4cedCe108B7Ad9a45698A8a1E52EdcC";
        const abi = [
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "recipients",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256[]",
                        "name": "amounts",
                        "type": "uint256[]"
                    }
                ],
                "name": "payMultiple",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            }
        ];
    
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    contract = new web3.eth.Contract(abi, contractAddress, { from: accounts[0] });
                } catch (error) {
                    document.getElementById('status').innerText = `Error: ${error.message}`;
                }
            } else {
                document.getElementById('status').innerText = "MetaMask is not installed.";
            }
        });
    
        document.getElementById('batchPaymentForm').addEventListener('submit', async (event) => {
            event.preventDefault();
    
            const recipients = [];
            const amounts = [];
            let totalAmount = web3.utils.toBN(0);
    
            document.querySelectorAll('.recipient').forEach((recipientDiv) => {
                const recipient = recipientDiv.querySelector('input[name="recipient"]').value;
                const amount = web3.utils.toBN(web3.utils.toWei(recipientDiv.querySelector('input[name="amount"]').value, 'ether'));
    
                recipients.push(recipient);
                amounts.push(amount);
                totalAmount = totalAmount.add(amount);
            });
    
            try {
                const accounts = await web3.eth.getAccounts();
                const tx = await contract.methods.payMultiple(recipients, amounts).send({ from: accounts[0], value: totalAmount });
                document.getElementById('status').innerText = `Transaction sent: ${tx.transactionHash}`;
            } catch (error) {
                document.getElementById('status').innerText = `Error: ${error.message}`;
            }
        });
    
        function addRecipient() {
            const recipientsDiv = document.getElementById('recipients');
            const newRecipientDiv = document.createElement('div');
            newRecipientDiv.classList.add('recipient');
            newRecipientDiv.innerHTML = `
                <label>Recipient Address:</label>
                <input type="text" name="recipient" required>
                <label>Amount (in ETH):</label>
                <input type="number" step="0.01" name="amount" required>
            `;
            recipientsDiv.appendChild(newRecipientDiv);
        }
    </script>
    
</body>
</html>
